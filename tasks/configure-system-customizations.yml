---
# Enable Banner Message
- name: Enable Banner Message
  replace: 
    path: /etc/gdm3/greeter.dconf-defaults
    regexp: '^#( banner-message-enable=true).*$'
    replace: \1
  become: true

# Insert Banner Message
- name: Insert Banner Message
  replace: 
    path: /etc/gdm3/greeter.dconf-defaults
    regexp: ^#( banner-message-text=\').*?\'.*$
    replace: \1{{ banner_message }}'
  become: true

# Install Customization Packages
- name: Install Customization packages with apt.
  apt:
    name: "{{ item.name | default(item) }}"
    state: "{{ item.state | default('present') }}"
  loop: "{{ customization_packages }}"
  become: true

# Install Flatpack Packages
- name: Install Customization packages with flatpak.
  community.general.flatpak:
    name: "{{ item.name | default(item) }}"
    state: "{{ item.state | default('present') }}"
    method: "{{ item.method | default('user') }}"
  loop: "{{ flatpak_packages }}"
  
# Required to modify dconf variables
- name: Install psutil python package.
  pip:
    name: psutil

# Disable Middle Click Paste
- name: Disable middle click paste.
  dconf:
    key: "/org.gnome.desktop.interface"
    value: "['gtk-enable-primary-paste', '{{ enable_middle_click_paste }}']"
    state: present

# Start TLP
- name: Start TLP
  systemd:
    name: tlp
    state: started
    enabled: true
  become: true

# Disable Bluetooth From Autostarting on Boot
- name: Disable Bluetooth from autostarting on boot
  replace: 
    path: /etc/tlp.conf
    regexp: ^#?(DEVICES_TO_DISABLE_ON_STARTUP=")bluetooth nfc wifi wwan".*$
    replace: \1{{ devices_to_disable }}"
  become: true

# Make Caffeine Indicator Start on boot
- name: Ensure caffeine-indicator is set to autostart.
  copy: 
    src: caffeine-indicator.desktop
    dest: /etc/xdg/autostart/caffeine-indicator.desktop
    owner: root
    group: root
    mode: '0644'
    force: no
  become: true